name: Build Universal macOS App

on:
  push:
    tags:
      - 'v*'           # 只有推送类似 v1.0 的标签时才触发构建，避免每次提交都构建
  workflow_dispatch:    # 允许在 GitHub 网页手动触发构建

jobs:
  build:
    runs-on: macos-latest  # 使用 GitHub 提供的最新 macOS（包含 M1 Runner）
    strategy:
      matrix:
        python-version: ['3.9']  # 建议使用兼容性好的 Python 版本

    steps:
    - name: Checkout 代码
      uses: actions/checkout@v3

    - name: 设置 Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install PyInstaller PySide6 aiohttp
        # 如果使用 requirements.txt，改为：pip install -r requirements.txt

    - name: 为双架构分别打包
      run: |
        # 1. 打包 x86_64 版本（在 M1 Runner 上通过 Rosetta 2 模拟运行）
        arch -x86_64 python -m PyInstaller \
          --onefile \
          --windowed \
          --name "CloudflareScan_x86_64" \
          --hidden-import=asyncio \
          --hidden-import=aiohttp \
          --hidden-import=PySide6.QtCore \
          --hidden-import=PySide6.QtGui \
          --hidden-import=PySide6.QtWidgets \
          --add-data "./:." \
          ./cfs-mac.py

        # 2. 打包原生 arm64 版本
        python -m PyInstaller \
          --onefile \
          --windowed \
          --name "CloudflareScan_arm64" \
          --hidden-import=asyncio \
          --hidden-import=aiohttp \
          --hidden-import=PySide6.QtCore \
          --hidden-import=PySide6.QtGui \
          --hidden-import=PySide6.QtWidgets \
          --add-data "./:." \
          ./cfs-mac.py

    - name: 合并为通用二进制
      run: |
        # 使用 lipo 工具合并两个架构的可执行文件
        lipo -create -output "CloudflareScan_Universal" \
          "./dist/CloudflareScan_x86_64" \
          "./dist/CloudflareScan_arm64"
        # 为合并后的文件添加执行权限
        chmod +x "CloudflareScan_Universal"
        # 查看合并后的架构信息（用于验证）
        lipo -info "CloudflareScan_Universal"

    - name: 准备发布文件
      run: |
        # 创建一个干净的发布文件夹
        mkdir -p release
        # 移动通用二进制文件
        mv "CloudflareScan_Universal" release/
        # 如果有图标等资源文件，也复制进来，例如：
        # cp cfs.icns release/ 2>/dev/null || true
        # 创建一个简单的说明文档
        echo "# Cloudflare Scan (Universal macOS App)" > release/README.txt
        echo "此程序为通用二进制版本，同时支持 Intel (x86_64) 和 Apple Silicon (arm64) 芯片的 Mac。" >> release/README.txt
        echo "构建于: $(date)" >> release/README.txt

    - name: 创建 Release 压缩包
      run: |
        cd release
        zip -r "../CloudflareScan_macOS_Universal.zip" .

    - name: 上传 Release 压缩包
      uses: actions/upload-artifact@v3
      with:
        name: CloudflareScan-Universal
        path: CloudflareScan_macOS_Universal.zip
