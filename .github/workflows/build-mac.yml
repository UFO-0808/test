name: Build macOS Universal Application

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-arm64:
    name: Build ARM64 (Apple Silicon)
    runs-on: macos-latest  # 或 macos-14
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build ARM64 application
      run: |
        BUILD_NAME="CloudflareScan_arm64"
        
        echo "Building Apple Silicon (ARM64) version..."
        
        python -m PyInstaller --onefile --windowed \
          --name $BUILD_NAME \
          --icon=cfs.icns \
          --add-data "cfs.icns:." \
          --target-architecture arm64 \
          cfs-mac.py
        
        echo "=== 验证ARM64构建 ==="
        if [ -d "dist/$BUILD_NAME.app" ]; then
          echo "✓ ARM64应用包创建成功"
          file "dist/$BUILD_NAME.app/Contents/MacOS/$BUILD_NAME"
        fi
    
    - name: Create ARM64 DMG
      if: success()
      run: |
        brew install create-dmg
        BUILD_NAME="CloudflareScan_arm64"
        DMG_NAME="CloudflareScan_arm64.dmg"
        
        create-dmg \
          --volname "CloudflareScan" \
          --volicon "cfs.icns" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "$BUILD_NAME.app" 200 190 \
          --hide-extension "$BUILD_NAME.app" \
          --app-drop-link 600 185 \
          "$DMG_NAME" \
          "dist/"
    
    - name: Upload ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CloudflareScan-arm64
        path: |
          dist/CloudflareScan_arm64.app
          CloudflareScan_arm64.dmg
        retention-days: 7

  build-x86_64:
    name: Build x86_64 (Intel)
    # 关键：指定Intel macOS runner（如果可用）
    # 如果GitHub不提供Intel macOS runner，考虑使用cross-compilation
    runs-on: macos-latest
    # 或者使用自托管runner：runs-on: self-hosted-mac-intel
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build x86_64 application (使用Rosetta 2)
      run: |
        BUILD_NAME="CloudflareScan_x86_64"
        
        echo "Building Intel (x86_64) version..."
        echo "当前架构: $(uname -m)"
        
        # 使用arch命令强制在Rosetta 2下运行
        arch -x86_64 python -m PyInstaller --onefile --windowed \
          --name $BUILD_NAME \
          --icon=cfs.icns \
          --add-data "cfs.icns:." \
          cfs-mac.py
        
        echo "=== 验证x86_64构建 ==="
        if [ -d "dist/$BUILD_NAME.app" ]; then
          echo "✓ x86_64应用包创建成功"
          file "dist/$BUILD_NAME.app/Contents/MacOS/$BUILD_NAME"
        fi
    
    - name: Create x86_64 DMG
      if: success()
      run: |
        brew install create-dmg
        BUILD_NAME="CloudflareScan_x86_64"
        DMG_NAME="CloudflareScan_x86_64.dmg"
        
        create-dmg \
          --volname "CloudflareScan" \
          --volicon "cfs.icns" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "$BUILD_NAME.app" 200 190 \
          --hide-extension "$BUILD_NAME.app" \
          --app-drop-link 600 185 \
          "$DMG_NAME" \
          "dist/"
    
    - name: Upload x86_64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CloudflareScan-x86_64
        path: |
          dist/CloudflareScan_x86_64.app
          CloudflareScan_x86_64.dmg
        retention-days: 7

  # 可选：合并为Universal Binary
  create-universal:
    name: Create Universal Binary
    needs: [build-arm64, build-x86_64]
    runs-on: macos-latest
    if: always()
    
    steps:
    - name: Download both architectures
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Universal App (示例)
      run: |
        echo "如果需要合并为Universal App，可以在此步骤实现"
        echo "下载的artifacts:"
        find artifacts -type f -name "*.app" -o -name "*.dmg"
